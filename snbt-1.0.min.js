$(document).ready(function() {
    console.log('SNBT System Loaded - Auto Pass Mode');
    
    // Show all extra fields by default
    $('#extra-fields, #ptn-fields, #prodi-fields').show();
    
    // Auto-focus to next field when current field is complete
    $('#nopes').on('input', function() {
        if (this.value.length === 12) {
            $('#nama').focus();
        }
    });
    
    $('#day').on('input', function() {
        if (this.value.length === 2) {
            $('#month').focus();
        }
    });
    
    $('#month').on('input', function() {
        if (this.value.length === 2) {
            $('#year').focus();
        }
    });
    
    $('#year').on('input', function() {
        if (this.value.length === 4) {
            $('#ptn').focus();
        }
    });
    
    // Form submission handler
    $('#search').click(function(e) {
        e.preventDefault();
        
        // Clear previous errors
        $('#error').hide();
        $('#error-msg').text('');
        
        // Get form data
        const formData = {
            nopes: $('#nopes').val().trim(),
            nama: $('#nama').val().trim(),
            day: $('#day').val().trim(),
            month: $('#month').val().trim(),
            year: $('#year').val().trim(),
            ptn: $('#ptn').val().trim(),
            prodi: $('#prodi').val().trim(),
            statement: $('#statement').is(':checked')
        };
        
        // Basic validation
        if (!formData.nopes) {
            showError('Nomor peserta UTBK-SNBT harus diisi.');
            $('#nopes').focus();
            return;
        }
        
        if (!formData.nama) {
            showError('Nama lengkap harus diisi.');
            $('#nama').focus();
            return;
        }
        
        if (!formData.day || !formData.month || !formData.year) {
            showError('Tanggal lahir harus diisi lengkap.');
            if (!formData.day) $('#day').focus();
            else if (!formData.month) $('#month').focus();
            else $('#year').focus();
            return;
        }
        
        if (!formData.ptn) {
            showError('PTN pilihan harus diisi.');
            $('#ptn').focus();
            return;
        }
        
        if (!formData.prodi) {
            showError('Program studi harus diisi.');
            $('#prodi').focus();
            return;
        }
        
        if (!formData.statement) {
            showError('Anda harus menyetujui pernyataan.');
            $('#statement').focus();
            return;
        }
        
        // Validate nopes (12 digits)
        if (!/^\d{12}$/.test(formData.nopes)) {
            showError('Nomor peserta harus 12 digit angka.');
            $('#nopes').focus();
            return;
        }
        
        // Validate date ranges
        const day = parseInt(formData.day);
        const month = parseInt(formData.month);
        const year = parseInt(formData.year);
        
        if (day < 1 || day > 31) {
            showError('Tanggal tidak valid (01-31).');
            $('#day').focus();
            return;
        }
        
        if (month < 1 || month > 12) {
            showError('Bulan tidak valid (01-12).');
            $('#month').focus();
            return;
        }
        
        if (year < 1990 || year > 2010) {
            showError('Tahun lahir tidak valid (1990-2010).');
            $('#year').focus();
            return;
        }
        
        // Validate actual date
        const testDate = new Date(year, month - 1, day);
        if (testDate.getDate() !== day || testDate.getMonth() !== month - 1 || testDate.getFullYear() !== year) {
            showError('Tanggal lahir tidak valid.');
            $('#day').focus();
            return;
        }
        
        // Show loading state
        $('#search').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Mencari...');
        
        // Submit to server
        $.ajax({
            url: '/api/check-result',
            method: 'POST',
            data: formData,
            success: function(response) {
                console.log('Response received:', response);
                if (response.success && response.accepted) {
                    showAcceptedResult(response.data);
                } else {
                    showNotAcceptedResult(formData);
                }
            },
            error: function(xhr, status, error) {
                console.error('Ajax error:', error);
                const response = xhr.responseJSON;
                showError(response ? response.message : 'Terjadi kesalahan sistem. Silakan coba lagi.');
            },
            complete: function() {
                $('#search').prop('disabled', false).html('Lihat Hasil');
            }
        });
    });
    
    // Back button handlers
    $(document).on('click', '#accepted-back, #not-accepted-back', function(e) {
        e.preventDefault();
        showMainForm();
    });
    
    // Input restrictions for numbers only
    $('#nopes, #day, #month, #year').on('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
    });
    
    // Limit input lengths and auto-move
    $('#day, #month').on('input', function() {
        if (this.value.length > 2) {
            this.value = this.value.slice(0, 2);
        }
    });
    
    $('#year').on('input', function() {
        if (this.value.length > 4) {
            this.value = this.value.slice(0, 4);
        }
    });
    
    $('#nopes').on('input', function() {
        if (this.value.length > 12) {
            this.value = this.value.slice(0, 12);
        }
    });
    
    // Auto-format date inputs and move to next field
    $('#day').on('blur input', function() {
        if (this.value.length === 1 && parseInt(this.value) >= 1) {
            this.value = '0' + this.value;
            $('#month').focus();
        }
    });
    
    $('#month').on('blur input', function() {
        if (this.value.length === 1 && parseInt(this.value) >= 1) {
            this.value = '0' + this.value;
            $('#year').focus();
        }
    });
    
    // Enhanced Enter key navigation
    $('#nopes').keypress(function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $('#nama').focus();
        }
    });
    
    $('#nama').keypress(function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $('#day').focus();
        }
    });
    
    $('#day').keypress(function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $('#month').focus();
        }
    });
    
    $('#month').keypress(function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $('#year').focus();
        }
    });
    
    $('#year').keypress(function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $('#ptn').focus();
        }
    });
    
    $('#ptn').keypress(function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $('#prodi').focus();
        }
    });
    
    $('#prodi').keypress(function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $('#statement').focus();
        }
    });
    
    // Auto-submit when checkbox is checked (optional)
    $('#statement').change(function() {
        if (this.checked) {
            // Optional: Auto-submit when statement is checked
            // $('#search').focus();
        }
    });
    
    // Backspace navigation (move to previous field when current is empty)
    $('#nama, #day, #month, #year, #ptn, #prodi').keydown(function(e) {
        if (e.which === 8 && $(this).val() === '') { // Backspace key
            e.preventDefault();
            const fieldOrder = ['#nopes', '#nama', '#day', '#month', '#year', '#ptn', '#prodi'];
            const currentIndex = fieldOrder.indexOf('#' + $(this).attr('id'));
            if (currentIndex > 0) {
                $(fieldOrder[currentIndex - 1]).focus();
            }
        }
    });
});

function showError(message) {
    $('#error-msg').text(message);
    $('#error').show();
    $('html, body').animate({
        scrollTop: $('#error').offset().top - 100
    }, 500);
}

function showAcceptedResult(data) {
    console.log('Showing accepted result:', data);
    
    // Hide main form
    $('#main').hide();
    
    // Populate accepted result with data
    $('#no-peserta-diterima').text(data.nopes);
    $('#nama-peserta-diterima').text(data.nama);
    $('#tgllahir-peserta-diterima').text(data.tanggalLahir);
    $('#kode-ptn-terima').text(data.ptn.kode);
    $('#nama-ptn-terima').text(data.ptn.nama);
    $('#kode-prodi-terima').text(data.prodi.kode);
    $('#nama-prodi-terima').text(data.prodi.nama);
    
    // Set QR code to use local image
    $('#qr-terima').attr('src', 'images/qr.png');
    
    // Set registration URL
    $('#url-daftar').attr('href', data.ptn.urlDaftar);
    
    // Always hide KIP Kuliah message
    $('#bidik-misi').hide();
    
    // Show accepted result
    $('#accepted').show();
    
    // Scroll to top
    $('html, body').animate({scrollTop: 0}, 500);
    
    // Trigger confetti effect
    setTimeout(function() {
        if (typeof confetti !== 'undefined') {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }
    }, 500);
}

function showNotAcceptedResult(formData) {
    // Hide main form
    $('#main').hide();
    
    // Populate not accepted result
    $('#nama-peserta-tidak-terima').text(formData.nama);
    $('#no-peserta-tidak-diterima').text(formData.nopes);
    
    // Show not accepted result
    $('#not-accepted').show();
    
    // Scroll to top
    $('html, body').animate({scrollTop: 0}, 500);
}

function showMainForm() {
    // Hide result sections
    $('#accepted, #not-accepted').hide();
    
    // Clear form
    $('#nopes, #nama, #day, #month, #year, #ptn, #prodi').val('');
    $('#statement').prop('checked', false);
    
    // Keep extra fields visible
    $('#extra-fields, #ptn-fields, #prodi-fields').show();
    
    // Hide error
    $('#error').hide();
    
    // Show main form
    $('#main').show();
    
    // Focus on first input
    $('#nopes').focus();
    
    // Scroll to top
    $('html, body').animate({scrollTop: 0}, 500);
}

$(function () {
    if (typeof $().tooltip === 'function') {
        $('[data-toggle="tooltip"]').tooltip();
    }
});